# Argo Workflows Helm Values
# Chart: argo-workflows v0.47.0
# App: v3.7.8

# Global image settings
images:
  tag: v3.7.8
  pullPolicy: IfNotPresent

# CRD installation
crds:
  install: true
  keep: true

# Workflow service account for running workflows
workflow:
  serviceAccount:
    create: true
    name: argo-workflow
  rbac:
    create: true

# Workflow Controller
controller:
  replicas: 2

  # Namespaces where workflows can run (only argo-workflows to avoid conflicts)
  workflowNamespaces:
    - argo-workflows

  # Workflow Archive - persist history to PostgreSQL
  persistence:
    archive: true
    postgresql:
      host: postgres-cluster-rw.postgres.svc.cluster.local
      port: 5432
      database: argo_workflows
      tableName: argo_workflows
      userNameSecret:
        name: argo-postgres-credentials
        key: username
      passwordSecret:
        name: argo-postgres-credentials
        key: password

  # Links to external systems (Grafana/Loki for logs)
  # See: https://argo-workflows.readthedocs.io/en/latest/links/
  links:
    - name: Workflow Logs
      scope: workflow
      url: "https://grafana.int.jigga.xyz/explore?orgId=1&left=%7B%22datasource%22:%22loki%22,%22queries%22:%5B%7B%22refId%22:%22A%22,%22expr%22:%22%7Bnamespace%3D%5C%22argo-workflows%5C%22,%20workflow%3D%5C%22${metadata.name}%5C%22%7D%22%7D%5D,%22range%22:%7B%22from%22:%22${status.startedAtEpoch}%22,%22to%22:%22${status.finishedAtEpoch}%22%7D%7D"
    - name: Pod Logs
      scope: pod-logs
      url: "https://grafana.int.jigga.xyz/explore?orgId=1&left=%7B%22datasource%22:%22loki%22,%22queries%22:%5B%7B%22refId%22:%22A%22,%22expr%22:%22%7Bnamespace%3D%5C%22argo-workflows%5C%22,%20pod%3D%5C%22${metadata.name}%5C%22%7D%22%7D%5D,%22range%22:%7B%22from%22:%22${status.startedAtEpoch}%22,%22to%22:%22${status.finishedAtEpoch}%22%7D%7D"

  # Resource limits
  resources:
    requests:
      cpu: 100m
      memory: 128Mi
    limits:
      cpu: 500m
      memory: 512Mi

  # Metrics for Prometheus
  metricsConfig:
    enabled: true
    port: 9090
    servicePort: 8080

  # Pod disruption budget for HA
  pdb:
    enabled: true
    minAvailable: 1

  # Logging
  logging:
    level: info
    format: json

  # Workflow defaults
  workflowDefaults:
    spec:
      # Use the argo-workflow service account for all workflows
      serviceAccountName: argo-workflow
      # Default timeout to prevent runaway workflows (1 hour)
      activeDeadlineSeconds: 3600
      # Security context - run as non-root for better security
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        fsGroup: 1000
      # Default TTL for completed workflows
      ttlStrategy:
        secondsAfterCompletion: 86400 # 1 day
        secondsAfterSuccess: 43200 # 12 hours
        secondsAfterFailure: 172800 # 2 days
      # Pod garbage collection - delay deletion to allow log viewing
      podGC:
        strategy: OnWorkflowSuccess
        deleteDelayDuration: 300s # Keep pods for 5 minutes after success

# Argo Server (UI)
server:
  replicas: 2

  # Authentication mode - server mode for basic auth
  authModes:
    - server

  # Resource limits
  resources:
    requests:
      cpu: 50m
      memory: 64Mi
    limits:
      cpu: 200m
      memory: 256Mi

  # Pod disruption budget
  pdb:
    enabled: true
    minAvailable: 1

  # Ingress (disabled - using separate ingress resource)
  ingress:
    enabled: false

  # Logging
  logging:
    level: info
    format: json

# Executor settings for workflow pods
executor:
  resources:
    requests:
      cpu: 10m
      memory: 32Mi
    limits:
      cpu: 100m
      memory: 128Mi
# Artifact Repository - Not using archiveLogs (not recommended per Argo docs)
# Logs are collected by Grafana Alloy and stored in Loki
# See: https://argo-workflows.readthedocs.io/en/latest/configure-archive-logs/#suggested-alternatives
# artifactRepository:
#   archiveLogs: false
