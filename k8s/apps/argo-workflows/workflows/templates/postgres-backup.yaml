# Postgres Backup WorkflowTemplate
apiVersion: argoproj.io/v1alpha1
kind: WorkflowTemplate
metadata:
  name: postgres-backup
  namespace: argo-workflows
  labels:
    app.kubernetes.io/name: postgres-backup
    app.kubernetes.io/component: workflow-template
spec:
  entrypoint: backup-cluster
  serviceAccountName: argo-workflow

  # Custom metrics for monitoring backup success/failure
  metrics:
    prometheus:
      - name: backup_last_completion_time
        help: "Timestamp of last backup completion"
        labels:
          - key: workflow_name
            value: "postgres-backup"
          - key: status
            value: "{{workflow.status}}"
        gauge:
          value: "{{workflow.creationTimestamp.s}}"
      - name: backup_duration_seconds
        help: "Duration of backup workflow in seconds"
        labels:
          - key: workflow_name
            value: "postgres-backup"
        when: "{{workflow.status}} == Succeeded"
        gauge:
          value: "{{workflow.duration}}"

  # NFS volume for backup storage (same as postgres namespace PVC)
  volumes:
    - name: backup
      nfs:
        server: 192.168.1.246
        path: /mnt/truenas-pool/pve/k8s/postgres

  templates:
    - name: backup-cluster
      steps:
        - - name: fetch-credentials
            template: get-postgres-password
        - - name: run-backup
            template: pg-dumpall
            arguments:
              parameters:
                - name: pg-password
                  value: "{{steps.fetch-credentials.outputs.parameters.pg-password}}"
        - - name: notify
            template: log-completion

    # Fetch postgres password from postgres namespace
    - name: get-postgres-password
      outputs:
        parameters:
          - name: pg-password
            valueFrom:
              path: /tmp/pg-password.txt
      container:
        image: bitnami/kubectl:latest
        command: ["/bin/sh", "-c"]
        args:
          - |
            kubectl get secret postgres-cluster-app -n postgres -o jsonpath='{.data.password}' | base64 -d > /tmp/pg-password.txt
            echo "Password fetched successfully"

    - name: pg-dumpall
      inputs:
        parameters:
          - name: pg-password
      container:
        image: postgres:18
        # Run as root to write to NFS share (TrueNAS permissions)
        securityContext:
          runAsUser: 0
          runAsGroup: 0
        command:
          - /bin/bash
          - -c
          - |
            set -e
            export POSTGRES_PASSWORD="{{inputs.parameters.pg-password}}"
            BACKUP_FILE="/backup/postgres-backup-$(date +%Y%m%d-%H%M%S).sql.gz"
            echo "Starting backup to $BACKUP_FILE"

            # Run pg_dumpall using app user (CloudNativePG disables password auth for postgres user)
            # Note: --no-role-passwords because app user can't dump password hashes
            PGPASSWORD="$POSTGRES_PASSWORD" pg_dumpall \
              -h postgres-cluster-rw.postgres.svc.cluster.local \
              -U app \
              --no-role-passwords \
              --clean \
              --if-exists | gzip > "$BACKUP_FILE"

            # Verify backup
            if [ -s "$BACKUP_FILE" ]; then
              SIZE=$(ls -lh "$BACKUP_FILE" | awk '{print $5}')
              echo "Backup completed successfully: $BACKUP_FILE ($SIZE)"

              # Cleanup old backups (keep last 7)
              cd /backup
              ls -t postgres-backup-*.sql.gz 2>/dev/null | tail -n +8 | xargs -r rm -f
              echo "Cleanup completed. Current backups:"
              ls -lh /backup/postgres-backup-*.sql.gz
            else
              echo "ERROR: Backup file is empty!"
              exit 1
            fi
        volumeMounts:
          - name: backup
            mountPath: /backup
        resources:
          requests:
            cpu: 100m
            memory: 256Mi
          limits:
            cpu: 500m
            memory: 512Mi

    - name: log-completion
      container:
        image: alpine:3.23
        command: ["/bin/sh", "-c"]
        args:
          - |
            echo "==================================="
            echo "Backup workflow completed at $(date)"
            echo "==================================="
