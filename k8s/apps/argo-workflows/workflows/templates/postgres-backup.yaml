# Postgres Backup WorkflowTemplate
apiVersion: argoproj.io/v1alpha1
kind: WorkflowTemplate
metadata:
  name: postgres-backup
  namespace: argo-workflows
  labels:
    app.kubernetes.io/name: postgres-backup
    app.kubernetes.io/component: workflow-template
spec:
  entrypoint: backup-cluster
  serviceAccountName: argo-workflow

  # NFS volume for backup storage (same as postgres namespace PVC)
  volumes:
    - name: backup
      nfs:
        server: 192.168.1.246
        path: /mnt/truenas-pool/pve/k8s/postgres

  templates:
    - name: backup-cluster
      steps:
        - - name: run-backup
            template: pg-dumpall
        - - name: notify
            template: log-completion

    - name: pg-dumpall
      container:
        image: postgres:18
        command:
          - /bin/bash
          - -c
          - |
            set -e
            BACKUP_FILE="/backup/postgres-backup-$(date +%Y%m%d-%H%M%S).sql.gz"
            echo "Starting backup to $BACKUP_FILE"

            # Run pg_dumpall using app user (CloudNativePG disables password auth for postgres user)
            # Note: --no-role-passwords because app user can't dump password hashes
            PGPASSWORD="$POSTGRES_PASSWORD" pg_dumpall \
              -h postgres-cluster-rw.postgres.svc.cluster.local \
              -U app \
              --no-role-passwords \
              --clean \
              --if-exists | gzip > "$BACKUP_FILE"

            # Verify backup
            if [ -s "$BACKUP_FILE" ]; then
              SIZE=$(ls -lh "$BACKUP_FILE" | awk '{print $5}')
              echo "Backup completed successfully: $BACKUP_FILE ($SIZE)"

              # Cleanup old backups (keep last 7)
              cd /backup
              ls -t postgres-backup-*.sql.gz 2>/dev/null | tail -n +8 | xargs -r rm -f
              echo "Cleanup completed. Current backups:"
              ls -lh /backup/postgres-backup-*.sql.gz
            else
              echo "ERROR: Backup file is empty!"
              exit 1
            fi
        env:
          - name: POSTGRES_PASSWORD
            valueFrom:
              secretKeyRef:
                name: postgres-cluster-app
                key: password
        volumeMounts:
          - name: backup
            mountPath: /backup
        resources:
          requests:
            cpu: 100m
            memory: 256Mi
          limits:
            cpu: 500m
            memory: 512Mi

    - name: log-completion
      container:
        image: alpine:3.19
        command: ["/bin/sh", "-c"]
        args:
          - |
            echo "==================================="
            echo "Backup workflow completed at $(date)"
            echo "==================================="
