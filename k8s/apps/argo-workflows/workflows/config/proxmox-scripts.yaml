# Proxmox template build scripts ConfigMap
apiVersion: v1
kind: ConfigMap
metadata:
  name: proxmox-scripts
  namespace: argo-workflows
  labels:
    app.kubernetes.io/name: argo-workflows
    app.kubernetes.io/component: config
data:
  build-template.sh: |
    #!/bin/bash
    # Ubuntu Cloud-Init Template Builder for Proxmox (Argo Workflows version)
    # Based on scripts/create-ubuntu-template.sh
    # Usage: build-template.sh <version> <codename> <template_id> <storage> <version_short> <hash>

    set -e

    VERSION="$1"
    CODENAME="$2"
    TEMPLATE_ID="$3"
    STORAGE="$4"
    VERSION_SHORT="$5"
    UPSTREAM_HASH="$6"

    TEMPLATE_NAME="ubuntu-${VERSION_SHORT}-cloudinit"
    IMAGE_URL="https://cloud-images.ubuntu.com/${CODENAME}/current/${CODENAME}-server-cloudimg-amd64.img"
    WORK_DIR="/tmp/pve-template"
    IMAGE_FILE="${WORK_DIR}/${CODENAME}-server-cloudimg-amd64.img"

    log_info() { echo "[INFO] $1"; }
    log_error() { echo "[ERROR] $1"; }

    log_info "========================================"
    log_info "Building Ubuntu $VERSION Template"
    log_info "========================================"
    log_info "Template ID:   $TEMPLATE_ID"
    log_info "Template Name: $TEMPLATE_NAME"
    log_info "Storage:       $STORAGE"
    log_info "Image URL:     $IMAGE_URL"
    log_info "========================================"

    # Create work directory
    mkdir -p "${WORK_DIR}"
    cd "${WORK_DIR}"

    # Download the cloud image
    log_info "Downloading Ubuntu $VERSION cloud image..."
    wget -q --show-progress -O "$IMAGE_FILE" "$IMAGE_URL"

    # Verify the hash
    log_info "Verifying image hash..."
    DOWNLOADED_HASH=$(sha256sum "$IMAGE_FILE" | awk '{print $1}')
    if [ "$DOWNLOADED_HASH" != "$UPSTREAM_HASH" ]; then
      log_error "Hash mismatch!"
      log_error "  Expected: $UPSTREAM_HASH"
      log_error "  Got:      $DOWNLOADED_HASH"
      rm -f "$IMAGE_FILE"
      exit 1
    fi
    log_info "Hash verified: ${DOWNLOADED_HASH:0:16}..."

    # Check for libguestfs-tools and install if needed
    log_info "Checking for libguestfs-tools..."
    if ! command -v virt-customize &>/dev/null; then
      log_info "Installing libguestfs-tools..."
      apt-get update && apt-get install -y libguestfs-tools
    fi

    # Customize the image
    log_info "Customizing cloud image..."
    virt-customize -a "${IMAGE_FILE}" \
      --firstboot-command 'dpkg --configure -a' \
      --firstboot-command 'apt-get update' \
      --firstboot-command 'apt-get install -y qemu-guest-agent nfs-common neofetch htop curl' \
      --firstboot-command 'systemctl enable qemu-guest-agent' \
      --firstboot-command 'systemctl start qemu-guest-agent' \
      --run-command 'apt-get clean'

    log_info "Image customization complete"

    # Remove existing VM/template if it exists
    if qm status ${TEMPLATE_ID} &>/dev/null; then
      log_info "Template ${TEMPLATE_ID} already exists, removing..."
      qm destroy ${TEMPLATE_ID} --purge || true
      sleep 2
    fi

    # Create the VM
    log_info "Creating VM $TEMPLATE_ID..."
    qm create ${TEMPLATE_ID} \
      --name "${TEMPLATE_NAME}" \
      --description "Ubuntu ${VERSION} (${CODENAME}) Cloud-Init Template | SHA256:${UPSTREAM_HASH} | Built: $(date -u '+%Y-%m-%d %H:%M UTC')" \
      --ostype l26 \
      --machine q35 \
      --cpu host \
      --cores 2 \
      --sockets 1 \
      --memory 2048 \
      --scsihw virtio-scsi-single \
      --net0 virtio,bridge=vmbr0,firewall=0 \
      --net1 virtio,bridge=vmbr1,firewall=0 \
      --serial0 socket \
      --vga serial0 \
      --tags template,ubuntu,cloud-init,ubuntu-${VERSION_SHORT}

    # Import the cloud image as the boot disk
    log_info "Importing cloud image to storage '${STORAGE}'..."
    qm set ${TEMPLATE_ID} --scsi0 ${STORAGE}:0,import-from="${IMAGE_FILE}",discard=on,ssd=1,iothread=1

    # Add cloud-init drive
    log_info "Adding cloud-init drive..."
    qm set ${TEMPLATE_ID} --ide2 ${STORAGE}:cloudinit

    # Configure boot settings
    log_info "Configuring boot settings..."
    qm set ${TEMPLATE_ID} --boot order=scsi0
    qm set ${TEMPLATE_ID} --agent enabled=1,fstrim_cloned_disks=1
    qm set ${TEMPLATE_ID} --ciuser groot
    qm set ${TEMPLATE_ID} --citype nocloud
    qm set ${TEMPLATE_ID} --hotplug disk,network,usb

    # Convert to template
    log_info "Converting VM to template..."
    qm template ${TEMPLATE_ID}

    # Cleanup
    log_info "Cleaning up..."
    rm -f "${IMAGE_FILE}"

    log_info "========================================"
    log_info "Template $TEMPLATE_ID created successfully"
    log_info "========================================"
    qm config "$TEMPLATE_ID" | grep -E 'name|description|tags'
