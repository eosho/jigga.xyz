apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: emqx
  namespace: mqtt
  labels:
    app: emqx
    app.kubernetes.io/name: emqx
    app.kubernetes.io/component: broker
spec:
  serviceName: emqx-headless
  replicas: 1  # EMQX Open Source only supports single node (clustering requires Enterprise license)
  podManagementPolicy: Parallel
  selector:
    matchLabels:
      app: emqx
  template:
    metadata:
      labels:
        app: emqx
    spec:
      securityContext:
        fsGroup: 1000
        runAsUser: 1000
        runAsGroup: 1000
      initContainers:
        - name: init-bootstrap
          image: busybox:1.37
          command:
            - /bin/sh
            - -c
            - |
              # Create auth bootstrap file with real passwords
              cat /bootstrap-template/auth-bootstrap.csv | \
                sed "s/HASS_PASSWORD_PLACEHOLDER/${HASS_PASSWORD}/g" | \
                sed "s/GOVEE_PASSWORD_PLACEHOLDER/${GOVEE_PASSWORD}/g" \
                > /opt/emqx/data/auth-bootstrap.csv
              echo "Bootstrap file created:"
              cat /opt/emqx/data/auth-bootstrap.csv
          envFrom:
            - secretRef:
                name: emqx-users
          volumeMounts:
            - name: bootstrap-template
              mountPath: /bootstrap-template
            - name: emqx-data
              mountPath: /opt/emqx/data
      containers:
        - name: emqx
          image: emqx/emqx:5.10
          ports:
            - containerPort: 1883
              name: mqtt
            - containerPort: 8883
              name: mqttssl
            - containerPort: 8083
              name: ws
            - containerPort: 8084
              name: wss
            - containerPort: 18083
              name: dashboard
            - containerPort: 4370
              name: ekka
            - containerPort: 5369
              name: genrpc
          envFrom:
            - configMapRef:
                name: emqx-config
            - secretRef:
                name: emqx-secret
          resources:
            requests:
              cpu: 100m
              memory: 256Mi
            limits:
              cpu: 500m
              memory: 512Mi
          volumeMounts:
            - name: emqx-data
              mountPath: /opt/emqx/data
          livenessProbe:
            httpGet:
              path: /api/v5/status
              port: 18083
            initialDelaySeconds: 60
            periodSeconds: 30
            timeoutSeconds: 10
          readinessProbe:
            httpGet:
              path: /api/v5/status
              port: 18083
            initialDelaySeconds: 45
            periodSeconds: 10
            timeoutSeconds: 5
      volumes:
        - name: bootstrap-template
          configMap:
            name: emqx-bootstrap
  volumeClaimTemplates:
    - apiVersion: v1
      kind: PersistentVolumeClaim
      metadata:
        name: emqx-data
      spec:
        accessModes: ["ReadWriteOnce"]
        storageClassName: ceph-rbd
        resources:
          requests:
            storage: 1Gi
