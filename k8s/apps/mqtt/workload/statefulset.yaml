apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: mosquitto
  namespace: mqtt
  labels:
    app: mosquitto
    app.kubernetes.io/name: mosquitto
    app.kubernetes.io/component: broker
spec:
  serviceName: mosquitto-headless
  replicas: 1
  podManagementPolicy: Parallel
  selector:
    matchLabels:
      app: mosquitto
  template:
    metadata:
      labels:
        app: mosquitto
    spec:
      securityContext:
        fsGroup: 1883
        runAsUser: 1883
        runAsGroup: 1883
      initContainers:
        - name: init-config
          image: eclipse-mosquitto:2.0
          securityContext:
            runAsUser: 0
          command:
            - /bin/sh
            - -c
            - |
              set -euo pipefail
              install -d -m 0750 /mosquitto/config
              cp /config-src/mosquitto.conf /mosquitto/config/mosquitto.conf

              # Create a password file from SOPS-managed secrets
              mosquitto_passwd -b -c /mosquitto/config/passwords hass "${HASS_PASSWORD}"
              mosquitto_passwd -b /mosquitto/config/passwords govee "${GOVEE_PASSWORD}"
              chmod 0600 /mosquitto/config/passwords
              chown -R 1883:1883 /mosquitto/config
          envFrom:
            - secretRef:
                name: mosquitto-users
          volumeMounts:
            - name: config-src
              mountPath: /config-src
              readOnly: true
            - name: mosquitto-config
              mountPath: /mosquitto/config
      containers:
        - name: mosquitto
          image: eclipse-mosquitto:2.0
          args:
            - mosquitto
            - -c
            - /mosquitto/config/mosquitto.conf
          ports:
            - containerPort: 1883
              name: mqtt
          resources:
            requests:
              cpu: 25m
              memory: 64Mi
            limits:
              cpu: 250m
              memory: 256Mi
          volumeMounts:
            - name: mosquitto-data
              mountPath: /mosquitto/data
            - name: mosquitto-config
              mountPath: /mosquitto/config
          livenessProbe:
            tcpSocket:
              port: 1883
            initialDelaySeconds: 15
            periodSeconds: 30
            timeoutSeconds: 10
          readinessProbe:
            tcpSocket:
              port: 1883
            initialDelaySeconds: 5
            periodSeconds: 30
            timeoutSeconds: 5
      volumes:
        - name: config-src
          configMap:
            name: mosquitto-config
        - name: mosquitto-config
          emptyDir: {}
  volumeClaimTemplates:
    - apiVersion: v1
      kind: PersistentVolumeClaim
      metadata:
        name: mosquitto-data
      spec:
        accessModes: ["ReadWriteOnce"]
        storageClassName: ceph-rbd
        resources:
          requests:
            storage: 1Gi
