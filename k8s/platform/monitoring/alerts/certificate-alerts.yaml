apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: certificate-alerts
  namespace: monitoring
  labels:
    app.kubernetes.io/name: prometheus
    app.kubernetes.io/component: alerts
spec:
  groups:
    - name: certificate.rules
      rules:
        - alert: CertificateExpiringSoon
          expr: (certmanager_certificate_expiration_timestamp_seconds - time()) / 86400 < 14
          for: 1h
          labels:
            severity: warning
          annotations:
            summary: "Certificate {{ $labels.name }} expiring soon"
            description: "Certificate {{ $labels.name }} in namespace {{ $labels.namespace }} will expire in {{ $value | printf \"%.0f\" }} days"

        - alert: CertificateExpiryCritical
          expr: (certmanager_certificate_expiration_timestamp_seconds - time()) / 86400 < 3
          for: 1h
          labels:
            severity: critical
          annotations:
            summary: "Certificate {{ $labels.name }} expiring very soon"
            description: "Certificate {{ $labels.name }} in namespace {{ $labels.namespace }} will expire in {{ $value | printf \"%.0f\" }} days. Immediate action required!"

        - alert: CertificateNotReady
          expr: certmanager_certificate_ready_status{condition="False"} == 1
          for: 15m
          labels:
            severity: warning
          annotations:
            summary: "Certificate {{ $labels.name }} is not ready"
            description: "Certificate {{ $labels.name }} in namespace {{ $labels.namespace }} has been in a not-ready state for 15 minutes"

        - alert: CertificateRenewalFailed
          expr: increase(certmanager_certificate_renewal_timestamp_seconds[1h]) == 0 and (certmanager_certificate_expiration_timestamp_seconds - time()) / 86400 < 7
          for: 1h
          labels:
            severity: warning
          annotations:
            summary: "Certificate {{ $labels.name }} renewal may be failing"
            description: "Certificate {{ $labels.name }} expires in less than 7 days and hasn't been renewed recently"
