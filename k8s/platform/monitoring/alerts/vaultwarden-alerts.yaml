apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: vaultwarden-alerts
  namespace: monitoring
  labels:
    app.kubernetes.io/name: vaultwarden
    app.kubernetes.io/component: alerts
    release: kube-prometheus-stack
spec:
  groups:
    - name: vaultwarden.rules
      rules:
        - alert: VaultwardenDown
          expr: up{job=~"vaultwarden.*"} == 0
          for: 2m
          labels:
            severity: critical
          annotations:
            summary: "Vaultwarden password manager is down"
            description: "Vaultwarden has been unavailable for more than 2 minutes. Password access is affected!"

        - alert: VaultwardenPodNotReady
          expr: kube_pod_status_ready{namespace="vaultwarden", condition="true"} == 0
          for: 5m
          labels:
            severity: critical
          annotations:
            summary: "Vaultwarden pod is not ready"
            description: "Vaultwarden pod {{ $labels.pod }} has been not ready for more than 5 minutes"

        - alert: VaultwardenHighMemory
          expr: |
            container_memory_usage_bytes{namespace="vaultwarden"}
            / container_spec_memory_limit_bytes{namespace="vaultwarden"} > 0.85
          for: 10m
          labels:
            severity: warning
          annotations:
            summary: "Vaultwarden high memory usage"
            description: "Vaultwarden container is using {{ $value | humanizePercentage }} of its memory limit"

        - alert: VaultwardenHighCPU
          expr: |
            rate(container_cpu_usage_seconds_total{namespace="vaultwarden"}[5m])
            / container_spec_cpu_quota{namespace="vaultwarden"} * 100000 > 80
          for: 10m
          labels:
            severity: warning
          annotations:
            summary: "Vaultwarden high CPU usage"
            description: "Vaultwarden container CPU usage is above 80% for more than 10 minutes"

        - alert: VaultwardenStorageAlmostFull
          expr: |
            kubelet_volume_stats_used_bytes{namespace="vaultwarden"}
            / kubelet_volume_stats_capacity_bytes{namespace="vaultwarden"} > 0.80
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: "Vaultwarden storage almost full"
            description: "Vaultwarden persistent volume is {{ $value | humanizePercentage }} full"

        - alert: VaultwardenRestarted
          expr: increase(kube_pod_container_status_restarts_total{namespace="vaultwarden"}[1h]) > 0
          for: 0m
          labels:
            severity: info
          annotations:
            summary: "Vaultwarden container restarted"
            description: "Vaultwarden container {{ $labels.container }} has restarted {{ $value | printf \"%.0f\" }} time(s) in the last hour"
